<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç­¾åæµ‹è¯•å·¥å…· - EdgeOne æ–‡ä»¶ä»£ç†</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 1px solid #eee;
            padding-bottom: 20px;
        }
        .header h1 {
            color: #333;
            margin-bottom: 8px;
        }
        .form-group {
            margin: 20px 0;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }
        input, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e1e1;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
            box-sizing: border-box;
        }
        input:focus, textarea:focus {
            outline: none;
            border-color: #007cba;
        }
        textarea {
            font-family: monospace;
            resize: vertical;
            min-height: 80px;
        }
        button {
            background: #007cba;
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            width: 100%;
            transition: background-color 0.3s;
        }
        button:hover {
            background: #005a87;
        }
        button:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }
        .result {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #007cba;
            display: none;
        }
        .error {
            background: #fdf4f4;
            border-left-color: #e53e3e;
            color: #c53030;
        }
        .code {
            background: #2d3748;
            color: #e2e8f0;
            padding: 16px;
            border-radius: 6px;
            margin: 10px 0;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        .success {
            color: #38a169;
            font-weight: 600;
        }
        .loading {
            display: none;
            text-align: center;
            color: #007cba;
        }
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        .button-group button {
            width: auto;
            flex: 1;
        }
        .nav-button {
            display: inline-block;
            padding: 10px 20px;
            background: #6b7280;
            color: white;
            text-decoration: none;
            border-radius: 6px;
            margin-bottom: 20px;
        }
        .nav-button:hover {
            background: #4b5563;
        }
    </style>
</head>
<body>
    <a href="/" class="nav-button">â† è¿”å›é¦–é¡µ</a>
    
    <div class="container">
        <div class="header">
            <h1>ğŸ” ç­¾åæµ‹è¯•å·¥å…·</h1>
            <p>ç”Ÿæˆç”¨äº EdgeOne æ–‡ä»¶ä»£ç†æœåŠ¡çš„æœ‰æ•ˆç­¾å</p>
        </div>

        <div class="form-group">
            <label for="filePath">ğŸ“ æ–‡ä»¶è·¯å¾„:</label>
            <input type="text" id="filePath" value="/test-file.txt" placeholder="ä¾‹å¦‚: /images/photo.jpg">
            <small>æ³¨æ„ï¼šè·¯å¾„åº”ä»¥æ–œæ  / å¼€å¤´</small>
        </div>
        
        <div class="form-group">
            <label for="expire">â° è¿‡æœŸæ—¶é—´ (ç§’):</label>
            <input type="number" id="expire" value="3600" min="1">
            <small>ç­¾åæœ‰æ•ˆæ—¶é•¿ï¼Œä»å½“å‰æ—¶é—´ç®—èµ·</small>
        </div>
        
        <div class="form-group">
            <label for="token">ğŸ”‘ API Token:</label>
            <textarea id="token" placeholder="è¯·è¾“å…¥æ‚¨çš„ API Token...">openlist-c041eb60-2278-4261-9681-b047fcda07d5kSCcjibUQ1WOchgaInwPXCnDtHU0qwyqqGEdYVtDFvaP6gAbk5UO3sTyOfYugiJs</textarea>
        </div>
        
        <button onclick="generateSignature()" id="generateBtn">ç”Ÿæˆç­¾å</button>
        
        <div class="loading" id="loading">
            â³ æ­£åœ¨ç”Ÿæˆç­¾å...
        </div>

        <div class="result" id="result">
            <h3>âœ¨ ç”Ÿæˆçš„ç­¾å:</h3>
            <div class="code" id="signatureResult"></div>
            
            <h3>ğŸ”— æµ‹è¯• URL:</h3>
            <div class="code" id="testUrl"></div>
            
            <p class="success">âœ… ç­¾åç”ŸæˆæˆåŠŸï¼æ‚¨å¯ä»¥å¤åˆ¶ä¸Šé¢çš„ URL è¿›è¡Œæµ‹è¯•ã€‚</p>
            
            <div class="button-group">
                <button onclick="testGeneratedUrl()" style="background: #38a169;">æµ‹è¯•ç”Ÿæˆçš„ URL</button>
                <button onclick="copyTestUrl()" style="background: #6b46c1;">å¤åˆ¶æµ‹è¯• URL</button>
            </div>
        </div>

        <div class="result error" id="errorResult" style="display: none;">
            <h3>âŒ é”™è¯¯ä¿¡æ¯:</h3>
            <p id="errorMessage"></p>
        </div>
    </div>

    <script>
        async function generateSignature() {
            // é‡ç½®æ˜¾ç¤ºçŠ¶æ€
            document.getElementById('result').style.display = 'none';
            document.getElementById('errorResult').style.display = 'none';
            document.getElementById('loading').style.display = 'block';
            document.getElementById('generateBtn').disabled = true;

            const filePath = document.getElementById('filePath').value.trim();
            const expire = parseInt(document.getElementById('expire').value);
            const token = document.getElementById('token').value.trim();
            
            // åŸºç¡€éªŒè¯
            if (!filePath) {
                showError('è¯·è¾“å…¥æ–‡ä»¶è·¯å¾„');
                return;
            }
            if (!filePath.startsWith('/')) {
                showError('æ–‡ä»¶è·¯å¾„å¿…é¡»ä»¥æ–œæ  / å¼€å¤´');
                return;
            }
            if (!expire || expire <= 0) {
                showError('è¯·è¾“å…¥æœ‰æ•ˆçš„è¿‡æœŸæ—¶é—´');
                return;
            }
            if (!token) {
                showError('è¯·è¾“å…¥ API Token');
                return;
            }

            try {
                console.log('å¼€å§‹ç”Ÿæˆç­¾åï¼Œå‚æ•°:', { filePath, expire, token: token.substring(0, 10) + '...' });

                // è®¡ç®—è¿‡æœŸæ—¶é—´æˆ³ï¼ˆå½“å‰æ—¶é—´ + è¿‡æœŸç§’æ•°ï¼‰
                const expireTimestamp = Math.floor(Date.now() / 1000) + expire;
                console.log('è¿‡æœŸæ—¶é—´æˆ³:', expireTimestamp);

                // å‡†å¤‡ç­¾åæ•°æ®
                const dataToSign = filePath + ":" + expireTimestamp;
                console.log('å¾…ç­¾åæ•°æ®:', dataToSign);

                // ç¼–ç å¯†é’¥å’Œæ•°æ®
                const encoder = new TextEncoder();
                const keyData = encoder.encode(token);
                const data = encoder.encode(dataToSign);

                console.log('å¯¼å…¥å¯†é’¥...');
                
                // å¯¼å…¥å¯†é’¥
                const key = await crypto.subtle.importKey(
                    "raw",
                    keyData,
                    { 
                        name: "HMAC",
                        hash: { name: "SHA-256" }
                    },
                    false,
                    ["sign"]
                );

                console.log('ç”Ÿæˆç­¾å...');
                
                // ç”Ÿæˆç­¾å
                const signature = await crypto.subtle.sign(
                    "HMAC",
                    key,
                    data
                );

                console.log('ç­¾åç”Ÿæˆå®Œæˆï¼Œå¤„ç†ç»“æœ...');

                // å°†ç­¾åè½¬æ¢ä¸º Base64
                const signatureArray = new Uint8Array(signature);
                let binary = '';
                
                // æ‰‹åŠ¨æ„å»º Base64 å­—ç¬¦ä¸²
                for (let i = 0; i < signatureArray.length; i++) {
                    binary += String.fromCharCode(signatureArray[i]);
                }
                
                const base64Encoded = btoa(binary)
                    .replace(/\+/g, "-")
                    .replace(/\//g, "_")
                    .replace(/=+$/, ""); // ç§»é™¤å°¾éƒ¨ç­‰å·

                const fullSignature = base64Encoded + ":" + expireTimestamp;
                
                console.log('ç”Ÿæˆçš„å®Œæ•´ç­¾å:', fullSignature);

                // æ˜¾ç¤ºç»“æœ
                document.getElementById('signatureResult').textContent = fullSignature;
                
                const testUrl = window.location.origin + '/api' + filePath + '?sign=' + encodeURIComponent(fullSignature);
                document.getElementById('testUrl').textContent = testUrl;
                document.getElementById('testUrl').dataset.url = testUrl;
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('result').style.display = 'block';
                
            } catch (error) {
                console.error('ç”Ÿæˆç­¾åæ—¶å‡ºé”™:', error);
                showError('ç”Ÿæˆç­¾åæ—¶å‡ºé”™: ' + error.message);
            } finally {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('generateBtn').disabled = false;
            }
        }

        function showError(message) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('generateBtn').disabled = false;
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorResult').style.display = 'block';
        }

        async function testGeneratedUrl() {
            const testUrl = document.getElementById('testUrl').dataset.url;
            if (!testUrl) {
                alert('è¯·å…ˆç”Ÿæˆæµ‹è¯• URL');
                return;
            }
            
            try {
                const response = await fetch(testUrl);
                const result = await response.json();
                
                if (response.ok) {
                    alert('âœ… æµ‹è¯•æˆåŠŸï¼æœåŠ¡å™¨è¿”å›: ' + JSON.stringify(result, null, 2));
                } else {
                    alert('âŒ æµ‹è¯•å¤±è´¥ï¼çŠ¶æ€ç : ' + response.status + ', é”™è¯¯: ' + (result.message || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                alert('ğŸš« è¯·æ±‚å¤±è´¥: ' + error.message);
            }
        }

        async function copyTestUrl() {
            const testUrl = document.getElementById('testUrl').dataset.url;
            if (!testUrl) {
                alert('æ²¡æœ‰å¯å¤åˆ¶çš„ URL');
                return;
            }
            
            try {
                await navigator.clipboard.writeText(testUrl);
                alert('âœ… URL å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
            } catch (error) {
                // é™çº§æ–¹æ¡ˆ
                const textArea = document.createElement('textarea');
                textArea.value = testUrl;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('âœ… URL å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
            }
        }
    </script>
</body>
</html>